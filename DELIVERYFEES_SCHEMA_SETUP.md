# DeliveryFees - Firestore Schema & Setup

## Collection Structure

### Firestore Console Path
```
Database: Firestore
Collection: DeliveryFees
Document: rates
```

### Visual Hierarchy
```
Firestore Database
└── DeliveryFees (collection)
    └── rates (document)
        ├── avg_base_fee (number)
        ├── avg_per_km_rate (number)
        ├── updated_at (timestamp)
        ├── updated_by (string)
        └── description (string)
```

## Document Schema (Full)

```javascript
{
  // Pricing Fields
  "avg_base_fee": 50.00,              // Number - Fixed base delivery fee
  "avg_per_km_rate": 10.00,           // Number - Variable rate per kilometer
  
  // Metadata
  "updated_at": Timestamp,             // Firestore Timestamp - When last updated
  "updated_by": "admin_user_123",     // String - Which admin updated it
  "description": "Average delivery rates for the platform"  // String - Description
}
```

## Field Types

| Field Name | Data Type | Example Value | Size | Notes |
|------------|-----------|---------------|------|-------|
| `avg_base_fee` | Number | 50.00 | 8 bytes | Base delivery charge |
| `avg_per_km_rate` | Number | 10.00 | 8 bytes | Per-kilometer rate |
| `updated_at` | Timestamp | 2026-02-09T14:30:00Z | variable | Auto-generated by Firestore |
| `updated_by` | String | "admin_001" | variable | User/Admin ID |
| `description` | String | "Average delivery rates..." | variable | Documentation |

## Validation Rules

```php
// PHP Validation (used in delivery-fees.php)
$avg_base = (float)($_POST['avg_base_fee'] ?? 0);  // Must be numeric
$avg_km = (float)($_POST['avg_per_km_rate'] ?? 0); // Must be numeric

// Both should be >= 0
if ($avg_base < 0 || $avg_km < 0) {
    // Validation error
}
```

## Firestore Security Rules

### Recommended Rules

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // DeliveryFees - Read for authenticated users, Write for admins
    match /DeliveryFees/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.token.is_admin == true;
    }
  }
}
```

### Alternative (More Restrictive)

```
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Only allow specific admin users
    match /DeliveryFees/rates {
      allow read: if request.auth != null;
      allow write: if request.auth != null && 
                      request.auth.uid in ['admin_001', 'admin_002'];
    }
  }
}
```

## Indexing

For this collection, Firestore usually doesn't require custom indexes since:
- You only read/write from `DeliveryFees/rates`
- No complex queries or filters

**No action needed** - Firestore's automatic indexing handles this.

## Storage & Reads/Writes

### Size Calculation
```
Per document (approximate):
- avg_base_fee: 8 bytes (number)
- avg_per_km_rate: 8 bytes (number)  
- updated_at: varies (timestamp)
- updated_by: ~15 bytes (string)
- description: ~60 bytes (string)
----------------------------------------
Total: ~100-150 bytes per document

With metadata overhead: ~200-300 bytes total
```

### Usage Pattern
```
Reads per day: ~100-1000 (depending on order volume)
Writes per day: ~1-5 (only when admin updates)
Estimated monthly cost: <$1 (well within free tier)
```

## Migration (If Coming from Settings Collection)

If you were previously using `Settings/delivery_rates`:

### Where Data Was
```
Before:
Settings
└── delivery_rates (document)
```

### Where Data Now
```
After:
DeliveryFees
└── rates (document)
```

### Migration Command (Firestore Console)
1. Export `Settings/delivery_rates` data
2. Create new `DeliveryFees` collection
3. Create `rates` document
4. Import exported data
5. Update `avg_base_fee` and `avg_per_km_rate` fields
6. Add `updated_at` (current timestamp)
7. Delete old `Settings/delivery_rates` document

## Querying Examples

### Get All Delivery Fees
```javascript
// Firestore console query
db.collection('DeliveryFees').doc('rates').get()
```

### List Collection Documents
```javascript
// If you add more documents later
db.collection('DeliveryFees').get()
```

### Query by Admin (Future)
```javascript
// Find rates updated by specific admin
db.collection('DeliveryFees').where('updated_by', '==', 'admin_001').get()
```

## Backup & Recovery

### Automatic Backups
- Firestore automatically backs up to Google Cloud Storage
- Enable in Firestore → Settings → Backups

### Manual Export
```bash
# Export DeliveryFees collection
gcloud firestore export gs://your-bucket/delivery-fees-backup
```

### Restore
```bash
# Restore from backup
gcloud firestore import gs://your-bucket/delivery-fees-backup
```

## Document Access Patterns

### Read Access
```
Application → Admin PHP → Firestore SDK → DeliveryFees/rates → Returns JSON
             getDeliveryFees()
```

### Write Access
```
Admin Panel Form → Submit POST → Validate → Firestore SDK → DeliveryFees/rates
                   delivery-fees.php
```

### Update Frequency
```
Typical: 1-5 times per week (when rates change)
Peak: During pricing adjustments
Off-peak: No reads when fetching cached rates
```

## Performance Considerations

### Latency
- Initial fetch: ~100-200ms (includes network)
- Subsequent calls with cache: <50ms
- Write: ~200-500ms (roundtrip)

### Optimization Tips
```php
// Cache in-memory to avoid repeated Firestore calls
static $cachedFees = null;

function getDeliveryFees() {
    global $pdo;
    
    // Use cached value if available
    if ($GLOBALS['cachedFees'] !== null) {
        return $GLOBALS['cachedFees'];
    }
    
    // Otherwise fetch from Firestore
    $fees = $pdo->getDocument('DeliveryFees', 'rates') ?? [];
    $GLOBALS['cachedFees'] = $fees;
    
    return $fees;
}
```

## Monitoring & Logging

### What Gets Logged
```
✓ When rates are fetched
✓ When calculation fails
✓ When rates are updated
✓ Who updated the rates (admin_id)
✓ When errors occur
```

### Log File Location
```
Your error logs (from error_log() calls):
- PHP error_log configuration directory
- Check with: error_get_last() or php -i | grep error_log
```

### Sample Log Entry
```
[2026-02-09 14:30:15] User 'admin_001' updated delivery rates: base=50, km=10
[2026-02-09 14:30:16] Error fetching delivery rates from Firestore: Connection timeout
```

## Scaling Considerations

### Small Scale (<1000 orders/day)
- Current setup is perfect
- Single `rates` document is ideal
- No indexing needed

### Medium Scale (1000-10000 orders/day)
- Consider caching in-memory
- No changes to structure needed
- Firestore easily handles this

### Large Scale (>10000 orders/day)
- Implement Redis caching
- Consider regional variations:
  ```
  DeliveryFees/
  ├── rates (default)
  ├── rates_metro_manila
  ├── rates_cebu
  ```

## Free Tier Limitations

```
Firestore Free Tier:
├── Reads: 50k/day
├── Writes: 20k/day
└── Deletes: 20k/day

Your usage:
├── Reads: ~100-1000/day
└── Writes: ~1-5/day

Status: ✅ Well within free tier
```

## Troubleshooting

### Issue: "Collection doesn't exist"
**Solution**: The collection auto-creates on first write. Save rates from admin panel.

### Issue: "Can't read/write"
**Solution**: Check Firestore security rules. Verify admin is authenticated.

### Issue: "Timestamp not saving"
**Solution**: Use `new DateTime()` in PHP (automatically converted by SDK).

### Issue: "Values showing as strings"
**Solution**: Ensure values are numbers not strings. Use `(float)` casting.

## Related Configuration

### In `delivery-fees.php`
```php
$feesCollection = 'DeliveryFees';  // Collection name
$feesDocId = 'rates';               // Document ID
```

### In `delivery-fees-helper.php`
```php
$feesCollection = 'DeliveryFees';  // Must match above
$feesDocId = 'rates';               // Must match above
```

### Make sure both files use the same collection/document names!
